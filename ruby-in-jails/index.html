<!DOCTYPE html><html lang="en"><head><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-E49JT23TS5"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js', new Date());    gtag('config', 'G-E49JT23TS5');</script><link href="assets/favicons/apple-touch-icon-57x57.png" rel="apple-touch-icon-precomposed" sizes="57x57"><link href="assets/favicons/apple-touch-icon-114x114.png" rel="apple-touch-icon-precomposed" sizes="114x114"><link href="assets/favicons/apple-touch-icon-72x72.png" rel="apple-touch-icon-precomposed" sizes="72x72"><link href="assets/favicons/apple-touch-icon-144x144.png" rel="apple-touch-icon-precomposed" sizes="144x144"><link href="assets/favicons/apple-touch-icon-60x60.png" rel="apple-touch-icon-precomposed" sizes="60x60"><link href="assets/favicons/apple-touch-icon-120x120.png" rel="apple-touch-icon-precomposed" sizes="120x120"><link href="assets/favicons/apple-touch-icon-76x76.png" rel="apple-touch-icon-precomposed" sizes="76x76"><link href="assets/favicons/apple-touch-icon-152x152.png" rel="apple-touch-icon-precomposed" sizes="152x152"><link href="assets/favicons/favicon-196x196.png" rel="icon" sizes="196x196" type="image/png"><link href="assets/favicons/favicon-96x96.png" rel="icon" sizes="96x96" type="image/png"><link href="assets/favicons/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"><link href="assets/favicons/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"><link href="assets/favicons/favicon-128.png" rel="icon" sizes="128x128" type="image/png"><meta content=" " name="application-name"><meta content="#FFFFFF" name="msapplication-TileColor"><meta content="mstile-144x144.png" name="msapplication-TileImage"><meta content="mstile-70x70.png" name="msapplication-square70x70logo"><meta content="mstile-150x150.png" name="msapplication-square150x150logo"><meta content="mstile-310x150.png" name="msapplication-wide310x150logo"><meta content="mstile-310x310.png" name="msapplication-square310x310logo"><!-- Social cards --><meta content="@ggfuzz" name="twitter:site"><meta content="Pine Cabin" property="og:site_name"><meta content="Ruby in Jails" name="twitter:title"><meta content="Ruby in Jails" property="og:title"><meta content="article" property="og:type"><meta content="My point here is that FreeBSD and Ruby go together like peanut butter and jelly and have for many years; this is not a new thing. Matz used to hang out on freebsd-hackers and much of Ruby’s philosophy comes from that community." name="twitter:description"><meta content="My point here is that FreeBSD and Ruby go together like peanut butter and jelly and have for many years; this is not a new thing. Matz used to hang out on freebsd-hackers and much of Ruby’s philosophy comes from that community." property="og:description"><meta content="summary_large_image" name="twitter:card"><meta content="https://pinecab.com/assets/images/pool.jpg" name="twitter:image"><meta content="https://pinecab.com/assets/images/pool.jpg" property="og:image"><!-- end of Social cards --><meta charset="UTF-8"><meta content="width=device-width, initial-scale=1.0" name="viewport"><meta content="ie=edge" http-equiv="X-UA-Compatible"><title>Ruby in Jails</title><link href="/assets/css/content.css" rel="stylesheet"></head><body class="text-center"><div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column"><header class="masthead mb-auto"><div class="inner"><h3 class="masthead-brand">Pine Cabin</h3><nav class="nav nav-masthead justify-content-center"><a class="nav-link" href="/">Home</a><a class="nav-link active" href="/contents">Contents</a><a class="nav-link" href="/about">About</a></nav></div></header><main class="inner cover" role="main"><h1 class="cover-heading">Ruby in Jails</h1><div class="display-date">February 15, 2013</div><p>A number of Ruby and Rails security vulnerabilities have come to light recently. <a href="http://www.kalzumeus.com/2013/01/31/what-the-rails-security-issue-means-for-your-startup/">This</a> is an excellent article about the situation and what you should do about it. If you do not have hardened servers you should follow the given advice to the letter. If you do need to rebuild this would be a good opportunity to migrate your infrastructure to chef, puppet or another tool that will allow you to easily rebuild again in the future.</p>

<p>But is it true that all servers will always be vulnerable? Can you not build out some servers that you can genuinely trust against common threats on an ongoing basis?</p>

<p>It is true that all networked servers will always be vulnerable against a suitably skilled &amp; determined attacker. But, yes, you can build out hardened servers that are extremely difficult to compromise–they will not protect you from a crack team of NSA PhDs or, worse, a really, really smart 13-year-old–but they will be immune to automated attacks as well as determined attacks from less-than-great hackers. Anyone who can compromise a well-hardened server has the skills to be making a lot of money, so you will generally be safe from most attack vectors unless compromising your server would be worth a lot of money to someone. But hopefully if you are in banking or such this is not your first introduction to hardened servers.</p>

<p>The Ruby community mostly uses Linux servers. I have extensive experience with Linux but when it comes to locking things down I prefer BSD. I started using Ruby about a decade ago when I ran across portupgrade(1) which is written in Ruby and at the time was FreeBSD’s primary tool for keeping third-party software from the ports system up to date. I was fascinated by how slow yet intelligent its behavior was; I could just keep running portupgrade(1) over and over again if I got stuck and it would eventually sort everything out. I have been a Rubyist ever since.</p>

<p>FreeBSD’s port system includes rubygem ports for gems with external dependencies. Install those and FreeBSD will make sure a gem’s dependencies are there prior to installation and everything gets upgraded in sync with proper versions forever. My upgrades look like
<code class="language-plaintext highlighter-rouge">portupgrade -aRr &amp;&amp; gem update</code></p>

<p>I almost never have to manually intervene; I cannot even remember the last time it happened. I have not had to install a dependency for a gem manually on FreeBSD in years.</p>

<p>My point here is that FreeBSD and Ruby go together like peanut butter and jelly and have for many years; this is not a new thing. Matz used to hang out on freebsd-hackers and much of Ruby’s philosophy comes from that community. That said, I do not expect many converts (and that’s fine with me–it makes me a harder target); but I do hope this will provide some ideas on how to lock down your own infrastructure, whatever platforms you may use. As with anything, one size does not fit all. In most of my environments I have at least a pair of hardened servers and try to keep the rest of the boxes as throwaway as possible. You do not have to lock every box down like Fort Meade. Unless you do.</p>

<p>I have included some links to the relevant FreeBSD documentation, which I find to be well-written, informative and helpful on most topics it covers.</p>

<p><strong>Securing the disk</strong>: <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/disks-encrypting.html">full encryption at the hardware level</a>
. This provides privacy even if the storage media itself is stolen or otherwise compromised (block-level copy).</p>

<p><strong>Securing access</strong>: only run services inside of <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/jails.html">jails</a> (shared kernel VMs) and do not allow in-band remote server access whatsoever; instead connect serial ports on your servers to a <a href="http://avocent.com/Products/Category/Serial_Appliances.aspx">console server</a> and only access physical hardware out of band. These days an analog modem is a worthy choice as it is completely off the radar of today’s script kiddie and, as a bonus, you can access your physical machines <em>even if your data center’s network goes down</em>. Plus you can access BIOS settings, single-user mode and other system functions not typically available with a remote shell. Console servers are traditionally pared with <a href="http://avocent.com/Products/Category/Power_Distribution_Units.aspx">remote power distribution units</a> (PDUs) which are essentially power strips that you can control programmatically if you, say, need to power cycle a stuck server on a given outlet(s). Together these devices provide the mechanisms necessary to write scripts to self-diagnose and self-correct pretty much any server failure short of actual hardware failure. Virtual versions of some of these facilities are available with virtualization software (VMWare Server, etc) and server management cards (though beware a lot of the UIs for the latter are Java-only. And buggy to boot.)</p>

<p><strong>Securing the process table and filesystem</strong>: securelevels, file flags, <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/mac.html">TrustedBSD/MAC framework</a>; in the hardlink OS jail model the read-only paritions (/, /usr – BSD is very good about keeping read-only and read-write files in separate trees so they can be treated different on disk) are all hardlinked (saving inodes across jails) and immutable from inside the jail even by root. Better yet, a jail does not have to have root access at all and only needs a bare minimum OS–even a a single service from a single binary file on a read-only file system with no root access–in order to run. You can take things even further by setting file flags (such as immutable, append-only, etc) that can only be changed when the system is in single-user mode. Thus an attacker can only change these files when sitting in front on the server or when connected via console server as networking (much less sshd) is not available in single-user mode. Or take it further still and use the MAC framework for truly deep control, including the ability to limit the powers of root. SELinux provides similar facilities in Linux.</p>

<p><strong>Securing the logs</strong>: these security features can provide extremely detailed security auditing and logging (and control). With a bit of elbow grease you can capture any sort of malicious system activity you can imagine. Be sure to secure a copy of those logs; seperate, hardened log servers are good. One set up to burn logs to non-rewritable optical media (DVD-R, etc) is even better. Security features can be configured to only allow appending to certain files, etc, unless the system is in single-user mode (or a similar safe state). There are many different paths you can take, just make sure your logs are safe.</p>

<p><strong>Securing the cloud</strong>: You do not own the cloud, you should not show the cloud your private data. Any data not meant for public download should be encrypted before being persisted in the cloud.</p>

<p><strong>Securing the data</strong>: If possible (unless you are dealing with petabytes of data, in other words) you should also be backing your data up to hardened boxes. If the worst happens you want to be 100% sure that no one can tamper with your backups. Put another set of encrypted backups in the cloud, by all means–two or three copies even to be safe–but always keep one set on a hardened server. Backups to physical media should be encrypted, no exceptions.</p>

<p><strong>Securing the network</strong>: I assume you already use an external firewall of some sort, whether it belongs to you or your provider. That’s great but I always also run the pf firewall locally on each server both to enforce security (for incoming traffic and for any ports opened by an unauthorized service) and to give me eyes into what is going on with the network on that box. This also lets me adapt the firewall on the fly–for example a script can watch the logs for excessive sshd login failures and then tell the firewall to block all traffic to and from from that IP address. PF also lets you route packets to and from local IP addresses so you can have any number of jails running on local IP addresses (127.0.0.2, 127.0.0.3, etc) each providing a different service on a different port on the same public IP address. In this way every service on a given public IP is provided by a different VM and a compromise to one is not a compromise to any other. Meanwhile the remote logging for all jails is running on the jail host (you can see all jail activity and read/write their filesystems from the jail host), which need not have in-band (ssh) access at all, and you have captured all the nefarious activity to your hardened log servers. Now you can make informed decisions about how to respond to the incident rather than having to assume that a compromised user account means wipe everything and start over. Which IS the correct response if you have not properly locked down your infrastructure.</p>

<p>You can never be entirely crackproof while connected to a network, but you can harden key bits of your infrastructure (the more layers of protection you have the more you frustrate any would-be attacker) and be prepared to quickly rebuild the rest from scratch if necessary–Chef, Puppet, PaaS from which you can spin up instances at will, whatever works best for your environment. Naturally not all of these safeguards will be available to use depending on your OS, hosting provider and other variables. This is not meant as a how-to but rather as an introduction to some tools that I use when securing my servers. With a bit of research and effort you can no doubt find similar tools for your platforms of choice.</p>

<br></main><footer class="mastfoot mt-auto"><div class="inner"><p class="copyright">&#169;2022 Jason Leonard</p></div></footer></div></body></html>